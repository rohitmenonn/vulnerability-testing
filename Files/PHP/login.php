<?php

if($_SERVER["REQUEST_METHOD"] == "POST") {
    $connectDB = mysqli_connect("localhost", "root", "password") or die('Could not connect to DB: '.mysqli_error());
    $db = mysqli_select_db($connectDB,"library");
    if(!$db){
        echo "Error Number: ".mysqli_errorno($connectDB);
        echo "Error: ".mysqli_error($connectDB);
    }
    
    $username = $_POST['username'];
    $password = $_POST['password'];
    
    try{
        $query = "select password from users where username = '$username'";
        $result = mysqli_query($connectDB,$query);
        while($row = mysqli_fetch_array($result)){
            if($password === $row[0]){
                session_start();
                if(!isset($_SESSION['user'])){
                    $_SESSION['user'] = $username;
                    $_SESSION['views'] = 0;
                }
                if(isset($_SESSION['user']) && isset($_SESSION['views'])){
                    $_SESSION['views'] += 1;
                    // echo "Logged in as: ". $_SESSION['user'], "<br>";
                    // echo "Number of times viewed: " . $_SESSION['views'];
                }
                setcookie('user',$username,time() + 60*60*24);
                header("Location: home.php");
            }else{
                echo "Not logged in <br>";
                echo "<a href=" ."signup.php" .">Register</a>";
            }
        }
    }catch(Exception $e){
        echo "An error has occured";
    }
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="../CSS/main.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-main">
            <h2 id="logo">LIB</h2>
            <div class="nav-toggler">
                <div class="nav-toggler-icon"><i class="fa fa-bars"></i></div>
            </div>
        </div>
        <ul class="nav-links">
            <li class="nav-link"><a href="./home.php">Home</a></li>
            <li class="nav-link"><a href="./search.php">Search</a></li>
            <li class="nav-link"><a href="./dashboard.php">Dashboard</a></li>
            <li class="nav-link"><a href="./register.php">Register</a></li>
        </ul>
    </nav>
    <div class="container">
        <div class="form-container">
            <form action="Files/PHP//login.php" method="POST">
                <h1>Login</h1>
                <p>Please fill in this form to login.</p>
                <label for="username"><b>Username</b></label>
                <input type="text" placeholder="Username" name="username" required><br>
                <label for="password"><b>Password</b></label>
                <input type="password" placeholder="Password" name="password" required><br>
                <div class="clearfix">
                    <button type="reset" class="cancelbtn">Cancel</button>
                    <button type="submit" class="signupbtn">Login</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="../JS/main.js"></script>
</body>
</html>
